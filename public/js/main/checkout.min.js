$(function() {
  $('body').on('select', () => true)
  $('#main-content').off();

  $('input').slice(2).on('focus', function() {
    $('.selection-list').addClass('collapse');
    $(document.documentElement).animate({
      scrollTop: $(this).offset().top - 250
    }, 300);
    $(this).click();
  })

  $('input').on('blur', function() {
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();
  })

  $('[name|=cust_type]').on('change', function() {
    if(this.value == 'company') {
      $('#first-name').addClass('collapse');
      $('#last-name').addClass('collapse');
      $('#company-name').removeClass('collapse');
      $('#trn').removeClass('collapse');
    }

    else {
      $('#first-name').removeClass('collapse');
      $('#last-name').removeClass('collapse');
      $('#company-name').addClass('collapse');
      $('#trn').addClass('collapse');
    }
  });

  $('.name').on('input focus', function() {
    let regex = /^ ?[A-Za-z]\D{2,} ?$/;
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();
    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The name is required.</div>`);
    } else if (!$(this).val().match(regex)) {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The name must contain<li>at least 3 letters</li><li>only spaces and letters</li></div>`);
    } else {
      $(this).parent().append(`<i class="fa-solid fa-circle-check input-validate valid-input"></i>`);
    }
  });
  
  $('#cname').on('input focus', function() {
    let regex = /^.{3,}$/;
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();
    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The company name is required.</div>`);
    } else if (!$(this).val().match(regex)) {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The company name must be<li>at least 3 characters.</li></div>`);
    } else {
      $(this).parent().append(`<i class="fa-solid fa-circle-check input-validate valid-input"></i>`);
    }
  });

  $('#trn-no').on('input focus', function() {
    let regex = /^(\d *){15,}$/;
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();
    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The trn number is required.</div>`);
    } else if (!$(this).val().match(regex)) {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The trn number must be<li>at least 15 digis.</li></div>`);
    } else {
      $(this).parent().append(`<i class="fa-solid fa-circle-check input-validate valid-input"></i>`);
    }
  });
  
  $('#email').on('input focus', function() {
    let regex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();

    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The email is required.</div>`);
    } else if (! $(this).val().match(regex)) {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The email must be a valid email address</div>`);
    } else {
      $(this).parent().append(`<i class="fa-solid fa-circle-check input-validate valid-input"></i>`);
    }
  });
  
  $('.address-input').on('input focus', function() {
    let regex = /\w+(\s\w+){2,}/;
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();

    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The address is required.</div>`);
    } else if (! $(this).val().match(regex)) {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">Invalid address.</div>`);
    } else {
      $(this).parent().append(`<i class="fa-solid fa-circle-check input-validate valid-input"></i>`);
    }
  });

  $('.dropdown-icon').on('click', function() {
    $(this).prevAll('.selection-input:first').focus();
  });

  $('.selection-input').on('focus', function() {
    $('.selection-list').addClass('collapse');
    let selectionList = $(this).nextAll('.selection-list:first');
    let count = $(selectionList).children('li').length;
    let index = 0;
    
    if(count > 0) {
      $(selectionList).removeClass('collapse');
      $(selectionList).children('li').eq(index).click();
      
      $(this).on('keydown', function(e) {
        $(selectionList).removeClass('collapse');
        if(e.keyCode == 40) {
          $(selectionList).children('li').removeClass('selected');
          $('body').css('overflow', 'hidden');
          index++;
          if (index == count) 
            index = 0;
          $(selectionList).children('li').eq(index).click();
        } else if(e.keyCode == 38) {
          $(selectionList).children('li').removeClass('selected');
          $('body').css('overflow', 'hidden');
          index--;
          if (index < 0) 
            index = count - 1;
          $(selectionList).children('li').eq(index).click();
        } else if(e.keyCode == 13) {
          e.preventDefault();
          if($(selectionList).hasClass('collapse'))
            $(selectionList).removeClass('collapse');
          else
            $(selectionList).addClass('collapse');
        }
      })
    }
  })

  $('.selection-input').on('blur', function() {
    $('body').css('overflow', 'auto');
    let selectionList = $(this).nextAll('.selection-list:first');
    $(selectionList).children('li').removeClass('selected');
  })

  $('.phone-input').on('input focus', function(event) {
    let phone = $(this).val().split(" ").join("");
  
    if(isNaN(Number(phone)))
      $(this).val($(this).val().slice(0, -1));

    let regex = /^(?:50|52|54|55|56|58|1|2|3|4|6|7|8|9)( *\d *){7}$/;
    $(this).nextAll('.input-validate:first').remove();
    $(this).closest('.phone-div').next('.error').remove();

    if($.trim($(this).val()) == '') {
      if(! $(this).hasClass('altphone-input')) {
        $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
        $(this).closest('.form-group').append(`<div class="error">The phone number is required.</div>`);
      }
    } else if (! $(this).val().match(regex)) {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">Invalid phone number.</div>`);
    } else {
      $(this).parent().append(`<i class="fa-solid fa-circle-check input-validate valid-input"></i>`);
    }
  });

  $('[name|=shipping_option]').on('change', function() {
    let total = parseFloat($('#grand-total-value').attr('data-total'));

    if(this.value == 'different') {
      $('#shipping-details').toggleClass('collapse');
      $('#cart-summary').css('max-height', '+=25em');
      let shipping = parseFloat($('#shipping-city-name').attr('data-shipping'));

      if(total > 100) {
        shipping = 0;
      }

      total += shipping;

      if(shipping) {
        $('#shipping-value').html('AED ' + shipping.toFixed(2));
        $('#grand-total-value').html('AED ' + total.toFixed(2));
      }
    }

    else {
      if(!$('#shipping-details').hasClass('collapse')) {
        $('#shipping-details').addClass('collapse');
        $('#cart-summary').css('max-height', '-=25em');
        $('#shipping-city').val(undefined);
        let shipping = parseFloat($('#city-name').attr('data-shipping'));

        if(total > 100) {
          shipping = 0;
        }
  
        total += shipping;
        
        $('#shipping-value').html('AED ' + shipping.toFixed(2));
        $('#grand-total-value').html('AED ' + total.toFixed(2));
      }
    }
  });
  
  $('[name|=pay_mthd]').on('change', function() {
    if(this.value == 'op') {
      $('#op-form').toggleClass('collapse');
      $('#cart-summary').css('max-height', '+=29.5em');
    }

    else {
      if(!$('#op-form').hasClass('collapse')) {
        $('#op-form').addClass('collapse');
        $('#cart-summary').css('max-height', '-=29.5em');
      }
    }
  });
  
  var prevCardKey;

  $('#account-no').on('keydown', function(event) {
    prevCardKey = event.key;
  })
  
  $('#account-no').on('input focus', function() {
    if(prevCardKey != 'Backspace' && prevCardKey != 'Delete')
      $(this).val($(this).val().slice(0, -1));
    let cardNumber = $(this).val().split(" ").join("");
    let cardLength = cardNumber.length;

    if (cardLength > 0 && cardLength < 16) {
      if(cardLength % 4 == 0) {
        $(this).val($(this).val().trim());
        $(this).val($(this).val() + ' ');
      }
    }

    if(! isNaN(prevCardKey) && cardLength != 16)
      $(this).val($(this).val() + prevCardKey);

    cardNumber = $(this).val().split(" ").join("");

    let regex = /^(?:4(\d *){12}(?:(\d *){3})?|(?:5[1-5](\d *){2}|222[1-9]|22[3-9](\d *)|2[3-6](\d *){2}|27[01](\d *)|2720)(\d *){12})$/;
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();

    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The card number is required.</div>`);
    } else if (! cardNumber.match(regex)) {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">Invalid card number.</div>`);
    } else {
      $(this).parent().append(`<i class="fa-solid fa-circle-check input-validate valid-input"></i>`);
    }
  });

  $('#expiry-month').on('focus', function() {
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();

    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The expiry month is required.</div>`);
    }
  });
  
  $('#expiry-month').on('input', function() {
    if(isNaN(Number($(this).val())) || $(this).val() > 12 || $(this).val().length > 2) {
      $(this).val($(this).val().slice(0, -1));
    }

    if($(this).val().length == 2)
      $('#expiry-year').focus();
  });
  
  $('#expiry-year').on('focus', function() {
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();

    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The expiry year is required.</div>`);
    }
  });
  
  $('#expiry-year').on('input', function() {
    let date = new Date();
    if(isNaN(Number($(this).val())) || $(this).val().length > 4) {
      $(this).val($(this).val().slice(0, -1));
    }
    
    if($(this).val().length == 4) {
      if($(this).val() < date.getFullYear() || $(this).val() > date.getFullYear() + 5) {
        this.placeholder = 'Invalid Year';
        this.value = '';
      }
      else
        $('#cvv-cvc').focus();
    }
  });

  $('#cvv-cvc').on('focus', function() {
    $(this).nextAll('.input-validate:first').remove();
    $(this).parent().next('.error').remove();

    if($.trim($(this).val()) == '') {
      $(this).parent().append(`<i class="fa-solid fa-circle-xmark input-validate input-error"></i>`);
      $(this).closest('.form-group').append(`<div class="error">The CVV/CVC is required.</div>`);
    }
  });
  
  $('#cvv-cvc').on('input', function() {
    if(isNaN(Number($(this).val())) || $(this).val().length > 3) {
      $(this).val($(this).val().slice(0, -1));
    }
  });

  $('#coupon-apply').on('click', function() {
    let coupon = $('#coupon-code').val();

    /* AJAX request for applying coupon */
    $.ajax({
      type: 'get',
      url: '/apply-coupon',
      cache: false,
      data: {
        coupon_code: coupon,
      },
      success: function (resp) {
        location.reload();
      },
      error: function (error) {
        $('.cart-totals').append('<div class="error">' + error.responseText + '</div>')
      }
    });
  })

  $('#order-form').on('submit', function() {
    $('body').css('height', '90vh');
    $('body').css('overflow', 'hidden');
    $('.loader-section').removeClass('collapse');
  });
});

function country(el, id) {
  let iso = $(el).attr('data-iso');
  let callCode = $(el).attr('data-call-code');

  $(el).siblings().removeClass('selected');
  $(el).addClass('selected');
  $(el).closest('.fl-bl').nextAll().find('.flag:first').attr('src', '/images/flags/' + iso + '.png');
  $(el).closest('.fl-bl').nextAll().find('.phone-code:first').val('+' + callCode);
  $(el).closest('.fl-bl').nextAll().find('.h-s-input').slice(0, 2).val('');
  $(el).closest('.fl-bl').nextAll().find('.selection-input').slice(0, 2).val('');
  $(el).parent().prevAll('.selection-input:first').val($(el).html());
  $(el).parent().prevAll('.h-s-input:first').val(id);

  /* AJAX request for getting states for country */
  $.ajax({
    type: 'get',
    url: '/states',
    cache: 'false',
    data: {
      id: id,
    },
    success: function (resp) {
      $(el).closest('.fl-bl').nextAll().find('.selection-list').slice(0, 2).empty();
      if(resp == '') {
        $(el).closest('.fl-bl').next().hide();
      }
      else {
        $(el).closest('.fl-bl').next().show();
        let stList = $(el).closest('.fl-bl').nextAll().find('.selection-list:first');

        resp.forEach((element) => {
          stList.append(`<li id="state-${element.id}" data-state="${element.id}" data-country="${id}" onclick="state(this)">${element.name}</li>`);
        });
      }
    },
    error: function () {
      alert("An error occured while accessing states")
    }
  });
}

function state(el) {
  let id = $(el).attr('data-state');
  let country_id = $(el).attr('data-country');

  $(el).siblings().removeClass('selected');
  $(el).addClass('selected');
  $(el).closest('.form-group').next().find('.h-s-input:first').val('');
  $(el).closest('.form-group').next().find('.selection-input:first').val('');
  $(el).parent().prevAll('.selection-input:first').val($(el).html());
  $(el).parent().prevAll('.h-s-input:first').val(id);

  /* AJAX request for getting cities for state */
  $.ajax({
    type: 'get',
    url: '/cities',
    cache: 'false',
    data: {
      id: id,
      country_id: country_id
    },
    success: function (resp) {
      $(el).closest('.form-group').next().find('.selection-list:first').empty();
      if(resp == '') {
        $(el).closest('.form-group').next().hide();
      }
      else {
        $(el).closest('.form-group').next().show();
        let ctList = $(el).closest('.form-group').nextAll().find('.selection-list:first');
        resp.forEach((element) => {
          ctList.append(`<li id="city-${element.id}" data-city="${element.id}" data-state="${id}" data-country="${country_id}" data-shipping="${element.shipping}" onclick="city(this)">${element.name}</li>`);
        });
      }
    },
    error: function () {
      alert("An error occured while accessing cities")
    }
  });
}

function city(el) {
  let id = $(el).attr('data-city');
  let shipping = parseFloat($(el).attr('data-shipping'));
  let total = parseFloat($('#grand-total-value').attr('data-total'));

  if(total > 100) {
    shipping = 0;
  }

  total += shipping;

  $(el).siblings().removeClass('selected');
  $(el).addClass('selected');
  $(el).parent().prevAll('.selection-input:first').val($(el).html());
  $(el).parent().prevAll('.h-s-input:first').val(id);

  if($(el).parent().attr('id') == 'shipping-cities') {
    $('#shipping-value').html('AED ' + shipping.toFixed(2));
    $('#grand-total-value').html('AED ' + total.toFixed(2));
  } else {
    if(! $('#shipping-city').val()) {
      $('#shipping-value').html('AED ' + shipping.toFixed(2));
      $('#grand-total-value').html('AED ' + total.toFixed(2));
    }
  }
}
